generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  ATTENDANT
  CLIENT
}

enum PaymentMethodType {
  ZELLE
  MOBILE_PAYMENT
  BINANCE
  CASH
  CARD
}

enum ValidationType {
  MANUAL
  AUTOMATIC
}

enum PaymentStatus {
  PENDING
  RECEIVED
  CANCELLED
}

enum PlanType {
  FLAT_RATE // Tasa fija mensual
  PER_VEHICLE // Cobro por vehículo registrado
  MIXED // Precio base + cobro por vehículo
}

enum FeeType {
  PERCENTAGE // Fee porcentual (ej: 10%)
  FIXED // Fee fijo (ej: $2 por vehículo)
}

model Company {
  id       String  @id @default(cuid())
  name     String
  photoUrl String? @db.Text
  isActive Boolean @default(true)

  deletedAt   DateTime?
  deletedById String?

  paymentMethods PaymentMethod[]
  valets         Valet[]
  companyUsers   CompanyUser[]
  parkingRecords ParkingRecord[]
  plans          CompanyPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deletedAt])
  @@map("companies")
}

model Valet {
  id       String @id @default(cuid())
  name     String
  idNumber String

  deletedAt DateTime?

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  parkingRecordsCheckIn  ParkingRecord[] @relation("CheckInValet")
  parkingRecordsCheckOut ParkingRecord[] @relation("CheckOutValet")

  @@index([companyId])
  @@index([deletedAt])
  @@map("valets")
}

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String
  name     String?
  role     UserRole
  phone    String?
  idNumber String?  @unique
  photoUrl String?  @db.Text
  isActive Boolean  @default(true)

  deletedAt   DateTime?
  deletedById String?

  ownedVehicles   Vehicle[]       @relation("VehicleOwner")
  payments        Payment[]       @relation("ProcessedBy")
  registerRecords ParkingRecord[] @relation("RegisterRecord")
  parkingRecords  ParkingRecord[]
  companyUsers    CompanyUser[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deletedAt])
  @@map("users")
}

model Vehicle {
  id    String  @id @default(cuid())
  plate String  @unique
  brand String?
  model String?
  color String?

  deletedAt DateTime?

  ownerId String?
  owner   User?   @relation("VehicleOwner", fields: [ownerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deletedAt])
  @@map("vehicles")
}

model ParkingRecord {
  id String @id @default(cuid())

  // Copia de información del vehículo (NO FK)
  plate String // Placa copiada
  brand String? // Marca copiada
  model String? // Modelo copiado
  color String? // Color copiado

  checkInAt  DateTime  @default(now())
  checkOutAt DateTime?
  notes      String?   @db.Text

  // Valet de entrada (quien recibe el vehículo)
  registerRecordId String?
  registerRecord   User?   @relation("RegisterRecord", fields: [registerRecordId], references: [id])
  checkInValetId   String?
  checkInValet     Valet?  @relation("CheckInValet", fields: [checkInValetId], references: [id])

  // Valet de salida (quien entrega el vehículo)
  checkOutValetId String?
  checkOutValet   Valet?  @relation("CheckOutValet", fields: [checkOutValetId], references: [id])

  // Cliente dueño del vehículo (solo para referencia)
  ownerId String?

  // Empresa a la que pertenece el registro
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@index([plate])
  @@index([checkInAt])
  @@index([ownerId])
  @@index([companyId])
  @@map("parking_records")
}

model PaymentMethod {
  id       String            @id @default(cuid())
  name     String
  form     String
  type     PaymentMethodType
  isActive Boolean           @default(true)

  deletedAt DateTime?

  payments        Payment[]
  company         Company?         @relation(fields: [companyId], references: [id])
  companyId       String?
  companyInvoices CompanyInvoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deletedAt])
  @@map("payment_methods")
}

model Payment {
  id              String         @id @default(cuid())
  amountUSD       Float
  tip             Float          @default(0) // Propina en USD
  status          PaymentStatus  @default(PENDING)
  date            DateTime       @default(now())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  parkingRecordId String
  parkingRecord   ParkingRecord  @relation(fields: [parkingRecordId], references: [id])
  reference       String? // Referencia del pago
  note            String?        @db.Text // Nota del pago
  fee             Float?
  validation      ValidationType

  processedById   String?
  processedBy     User?          @relation("ProcessedBy", fields: [processedById], references: [id])
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId String?

  @@index([parkingRecordId])
  @@index([status])
  @@index([date])
  @@map("payments")
}

model CompanyPlan {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  planType  PlanType

  flatRate       Float?
  perVehicleRate Float?
  feeType        FeeType?
  feeValue       Float?
  basePrice      Float?

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyInvoices CompanyInvoice[]

  @@index([companyId])
  @@index([deletedAt])
  @@map("company_plans")
}

model CompanyInvoice {
  id            String         @id @default(cuid())
  companyPlanId String
  companyPlan   CompanyPlan    @relation(fields: [companyPlanId], references: [id])
  amountUSD     Float
  status        PaymentStatus  @default(PENDING)
  date          DateTime       @default(now())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  reference     String?
  note          String?        @db.Text
  validation    ValidationType

  // Detalle del cálculo
  planType      PlanType
  vehicleCount  Int? // Cantidad de vehículos en el período
  baseAmount    Float? // Monto base (flatRate o basePrice)
  vehicleAmount Float? // Monto por vehículos
  feeAmount     Float? // Monto del fee aplicado
  periodStart   DateTime? // Inicio del período facturado
  periodEnd     DateTime? // Fin del período facturado

  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId String?

  @@map("company_invoices")
}

model CompanyUser {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  joinedAt  DateTime @default(now())
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("company_users")
}
